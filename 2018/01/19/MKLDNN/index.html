<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="技术," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="介绍MKLDNN是一个Intel开发的基于Intel芯片架构的开源库，提供用于深度学习的API.Intel 开源软件中心MKLDNN Github 主页
编译安装mkldnn1234561. Git clone mkldnn2. source psxe3. Cd mkldnn &amp;amp;&amp;amp; mkdir build &amp;amp;&amp;amp; cd build4. CC=icc CXX=icpc">
<meta property="og:type" content="article">
<meta property="og:title" content="MKLDNN">
<meta property="og:url" content="http://yoursite.com/2018/01/19/MKLDNN/index.html">
<meta property="og:site_name" content="沉思语录">
<meta property="og:description" content="介绍MKLDNN是一个Intel开发的基于Intel芯片架构的开源库，提供用于深度学习的API.Intel 开源软件中心MKLDNN Github 主页
编译安装mkldnn1234561. Git clone mkldnn2. source psxe3. Cd mkldnn &amp;amp;&amp;amp; mkdir build &amp;amp;&amp;amp; cd build4. CC=icc CXX=icpc">
<meta property="og:updated_time" content="2019-03-05T12:24:27.547Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MKLDNN">
<meta name="twitter:description" content="介绍MKLDNN是一个Intel开发的基于Intel芯片架构的开源库，提供用于深度学习的API.Intel 开源软件中心MKLDNN Github 主页
编译安装mkldnn1234561. Git clone mkldnn2. source psxe3. Cd mkldnn &amp;amp;&amp;amp; mkdir build &amp;amp;&amp;amp; cd build4. CC=icc CXX=icpc">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/01/19/MKLDNN/"/>





  <title> MKLDNN | 沉思语录 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">沉思语录</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">取次花丛懒回顾，半缘修道半缘君</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/19/MKLDNN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Leslie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/popeve.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沉思语录">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                MKLDNN
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-19T17:02:02+08:00">
                2018-01-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/19/MKLDNN/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/01/19/MKLDNN/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv">本文总阅读量
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>MKLDNN是一个Intel开发的基于Intel芯片架构的开源库，提供用于深度学习的API.<br><a href="https://github.com/01org" target="_blank" rel="external">Intel 开源软件中心</a><br><a href="https://github.com/01org/mkl-dnn" target="_blank" rel="external">MKLDNN Github 主页</a></p>
<h2 id="编译安装mkldnn"><a href="#编译安装mkldnn" class="headerlink" title="编译安装mkldnn"></a>编译安装mkldnn</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1. Git clone mkldnn</div><div class="line">2. source psxe</div><div class="line">3. Cd mkldnn &amp;&amp; mkdir build &amp;&amp; cd build</div><div class="line">4. CC=icc CXX=icpc cmake .. -DCMAKE_INSTALL_PREFIX=../mkldnn_install/</div><div class="line">    ##debug版本编译加参数 -DCMAKE_BUILD_TYPE=Debug</div><div class="line">5. CC=icc CXX=icpc make -j 66 &amp;&amp; make install</div></pre></td></tr></table></figure>
<p>make install之后：<br>如果第二步没有指定目录，会安装在/usr/local目录下面<br>Shared libraries (/usr/local/lib):<br>头文件：<br>Header files (/usr/local/include):<br>文档:<br>Documentation (/usr/local/share/doc/mkldnn):</p>
<h2 id="编译链接代码："><a href="#编译链接代码：" class="headerlink" title="编译链接代码："></a>编译链接代码：</h2><p><a href="https://software.intel.com/en-us/articles/intel-mkl-dnn-part-1-library-overview-and-installation" target="_blank" rel="external">入门文档</a><br>这个文档内容有点问题：<br>具体编译的命令看github的readme：<a href="https://github.com/01org/mkl-dnn" target="_blank" rel="external">https://github.com/01org/mkl-dnn</a><br>首先配置环境变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">source psxe(应该只需要mkl模块)</div><div class="line">export MKLDNNROOT=/home/automation/mkldnn/selfBuilt/mkl-dnn-0.12/mkldnn_install</div><div class="line"></div><div class="line">G++ 编译</div><div class="line">g++ -std=c++11 -I$&#123;MKLDNNROOT&#125;/include -L$&#123;MKLDNNROOT&#125;/lib simple_net.cpp -lmkldnn -o ./bin/simple_net_cpp</div><div class="line">编译debug版本:</div><div class="line">g++ -g -std=c++11 -I$&#123;MKLDNNROOT&#125;/include -L$&#123;MKLDNNROOT&#125;/lib simple_net.cpp -lmkldnn -o ./bin/simple_net_cpp</div><div class="line"></div><div class="line">用icc编译的话：</div><div class="line">icpc -std=c++11 -I$&#123;MKLDNNROOT&#125;/include -L$&#123;MKLDNNROOT&#125;/lib simple_net.cpp -lmkldnn -o ./bin_icc/simple_net_cpp</div></pre></td></tr></table></figure></p>
<p>编译完的运行：<br>报错找不到mkldnn的动态链接库<br>添加动态链接库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">export LD_LIBRARY_PATH=$LD_LIBRARY_PATH://home/automation/mkldnn/selfBuilt/mkl-dnn-0.12/mkldnn_install/lib</div><div class="line"></div><div class="line">报错找不到mkl_rt：</div><div class="line">source 一下mkl或者psxe</div><div class="line"></div><div class="line">然后运行：</div><div class="line">./bin_icc/simple_net_cpp</div><div class="line">运行成功，不会报错</div></pre></td></tr></table></figure></p>
<h2 id="Simple-Net-Code-API-代码的解释"><a href="#Simple-Net-Code-API-代码的解释" class="headerlink" title="Simple_Net Code API 代码的解释"></a>Simple_Net Code API 代码的解释</h2><p><a href="https://software.intel.com/en-us/articles/intel-mkl-dnn-part-2-sample-code-build-and-walkthrough" target="_blank" rel="external">https://software.intel.com/en-us/articles/intel-mkl-dnn-part-2-sample-code-build-and-walkthrough</a></p>
<h2 id="调试simple-net-cpp代码"><a href="#调试simple-net-cpp代码" class="headerlink" title="调试simple_net.cpp代码"></a>调试simple_net.cpp代码</h2><h3 id="看一个primitive的例子："><a href="#看一个primitive的例子：" class="headerlink" title="看一个primitive的例子："></a>看一个primitive的例子：</h3><h4 id="step1："><a href="#step1：" class="headerlink" title="step1："></a>step1：</h4><p>line:117<br>convolution_forward(conv1_prim_desc, conv1_src_memory,<br>            conv1_weights_memory, user_bias_memory,<br>            conv1_dst_memory)<br>convolution_forward就是primitive的名字</p>
<h4 id="step2："><a href="#step2：" class="headerlink" title="step2："></a>step2：</h4><p>看convolution_forward的构造函数调用了mkldnn_primitive_create</p>
<h4 id="step3："><a href="#step3：" class="headerlink" title="step3："></a>step3：</h4><p>mkldnn_primitive_create的构造函数：<br>调用了primitive_desc-&gt;create_primitive</p>
<h4 id="step4"><a href="#step4" class="headerlink" title="step4:"></a>step4:</h4><p>看primitive_desc-&gt;create_primitive<br>这个是个虚函数，需要看具体的primitive_desc子类的实现<br>用gdb去看看到底调用哪个实现函数<br><strong>debug</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">gdb a.out</div><div class="line">break primitive.cpp:35(mkldnn_primitive_create这个函数上)</div><div class="line">单步调试到return primitive_desc-&gt;create_primitive(primitive, inputs, outputs);</div><div class="line">看看调用了哪个kernel</div><div class="line">bt</div></pre></td></tr></table></figure></p>
<p>单步调试n，遇到return primitive_desc-&gt;create_primitive(primitive, inputs, outputs); s：step in这个实现</p>
<h5 id="看到create-primitive函数创建memory的时候调用了"><a href="#看到create-primitive函数创建memory的时候调用了" class="headerlink" title="看到create_primitive函数创建memory的时候调用了"></a>看到create_primitive函数创建memory的时候调用了</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#0  mkldnn::impl::cpu::cpu_memory_t::pd_t::create_primitive (this=0x634400, primitive=0x7ffffffea508, inputs=0x0,</div><div class="line">    outputs=0x0) at /home/lesliefang/mkldnn/mkl-dnn-0.17.2/src/cpu/cpu_memory.hpp:45</div></pre></td></tr></table></figure>
<h5 id="reoder这个op对应了"><a href="#reoder这个op对应了" class="headerlink" title="reoder这个op对应了"></a>reoder这个op对应了</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/home/lesliefang/mkldnn/mkl-dnn-0.17.2/src/cpu/jit_uni_reorder.cpp:818</div></pre></td></tr></table></figure>
<h5 id="conv这个op"><a href="#conv这个op" class="headerlink" title="conv这个op"></a>conv这个op</h5><p>对应调用到了/home/lesliefang/mkldnn/mkl-dnn-0.17.2/src/cpu/<br>jit_avx512_common_convolution.hpp:46<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">jit_avx512_common_convolution_fwd_t的构造函数里面new jit_avx512_common_conv_fwd_kernel</div><div class="line"></div><div class="line">jit_avx512_common_conv_fwd_kernel构造函数里面调用generate方法</div><div class="line">generate方法就是jit去生成汇编，可以看到里面调用了xbyak的库函数</div></pre></td></tr></table></figure></p>
<p>进一步看generate方法：</p>
<h6 id="jcp变量"><a href="#jcp变量" class="headerlink" title="jcp变量"></a>jcp变量</h6><p>jcp是一个jit_conv_conf_t类型的成员变量<br>在jit_avx512_common_conv_fwd<em>kernel初始化成员列表里面做初始化jcp(ajcp)<br>ajcp是传进来的参数conf</em>.jcp<em><br>conf</em>是jit_avx512_common_convolution_fwd_t的成员变量pd<em>t conf</em>;<br>在jit_avx512_common_convolution_fwd<em>t初始化成员函数列表里面构造conf</em>(*pd)</p>
<p>generate函数开始从jcp里面读出输入输出变量的维度<br>计算会调用compute_loop函数，compute_loop根据jcp.ver类型选择调用compute_loop_vnni或者compute_loop_4fma</p>
<h2 id="多线程计算的实现"><a href="#多线程计算的实现" class="headerlink" title="多线程计算的实现"></a>多线程计算的实现</h2><p>需要链接openMP去实现</p>
<h3 id="step1"><a href="#step1" class="headerlink" title="step1:"></a>step1:</h3><p>全局搜<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">grep -rni &quot;pragma omp parallel&quot;</div><div class="line">看到</div><div class="line">src/common/mkldnn_thread_parallel_nd.hpp:47:#   pragma omp parallel num_threads(nthr)</div><div class="line">src/common/mkldnn_thread_parallel_nd.hpp:154:#   pragma omp parallel</div></pre></td></tr></table></figure></p>
<p>应该是封装在了这个parallel函数里面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#elif MKLDNN_THR == MKLDNN_THR_OMP</div><div class="line">    if (nthr == 1) &#123; f(0, 1); return; &#125;</div><div class="line">#   pragma omp parallel num_threads(nthr)</div><div class="line">    f(mkldnn_get_thread_num(), mkldnn_get_num_threads());</div></pre></td></tr></table></figure></p>
<p>一般用openMP的线程不用tbb的线程</p>
<h3 id="step2"><a href="#step2" class="headerlink" title="step2:"></a>step2:</h3><p>在src目录下面搜索parallel的函数调用<br>是在execute函数里面调用的，所以并行化是在stream提交了之后，调用kernel的execute的函数的时候执行的<br>继续以simple_net.cpp代码中的jit_avx512_common_convolution.hpp:46的jit_avx512_common_convolution_fwd_t作为例子<br>stream提交之后会调用jit_avx512_common_convolution_fwd_t中的execute函数，如果2D卷积的话调用execute_forward_2d函数<br>这个函数里面调用了parallel函数去做多线程运算<br>parallel函数的第二个参数就是每个线程要执行的函数，一般就是个lamba匿名函数<br>匿名函数里面通过jit_conv_ker_pipeline_ow<em>thr去调用kernel</em>-&gt;jit_ker执行运算</p>
<p>kernel_变量在_jit_avx512_common_convolution_fwd<em>t构造函数里面实现<br>kernel</em> = new jit_avx512_common_conv_fwd<em>kernel(conf</em>.jcp<em>,<br>            *conf</em>.attr());<br>jit_ker在jit_avx512_common_conv_fwd_kernel的构造函数里面通过jit_ker = (void (*)(jit_conv_call_s *))getCode();实现</p>
<h2 id="MKLDNN的primitive如何选择对应的kernel"><a href="#MKLDNN的primitive如何选择对应的kernel" class="headerlink" title="MKLDNN的primitive如何选择对应的kernel"></a>MKLDNN的primitive如何选择对应的kernel</h2><p>在调用privimite-&gt;create_primitivate的时候会去遍历所有的kernel，在每个kernel的函数中都有一个init_conf的函数，在遍历所有的kernel的时候，会去看这个init_conf的函数是否满足条件，满足条件就意味着调用这个kernel，否则的话就看下个kernel</p>
<p>以_jit_avx512_common_convolution_fwd_t为例子<br>是在构造primitive desc的时候就选择好了使用哪个kernel</p>
<h3 id="step1-1"><a href="#step1-1" class="headerlink" title="step1:"></a>step1:</h3><p>在line:93<br>auto conv1_prim_desc<br>            = convolution_forward::primitive_desc(conv1_desc, cpu_engine);<br>创建primitive desc</p>
<h3 id="step2-1"><a href="#step2-1" class="headerlink" title="step2:"></a>step2:</h3><p>convolution_forward::primitive_desc构造函数中调用mkldnn::primitive_desc</p>
<h3 id="step3"><a href="#step3" class="headerlink" title="step3:"></a>step3:</h3><p>mkldnn::primitive_desc里面调用mkldnn_primitive_desc_iterator_create_v2</p>
<h3 id="step4-1"><a href="#step4-1" class="headerlink" title="step4:"></a>step4:</h3><p>mkldnn_primitive_desc_iterator_create_v2函数里面创建primitive_desc_iterator_t对象<br>这个函数比较难懂，记录下自己的理解<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">status_t mkldnn_primitive_desc_iterator_create_v2(</div><div class="line">        primitive_desc_iterator_t **iterator, const_c_op_desc_t c_op_desc,</div><div class="line">        const primitive_attr_t *attr, engine_t *engine,</div><div class="line">        const primitive_desc_t *hint_fwd_pd) &#123;</div><div class="line">    const op_desc_t *op_desc = (const op_desc_t *)c_op_desc;</div><div class="line"></div><div class="line">    auto it = new primitive_desc_iterator_t(engine, op_desc, attr, hint_fwd_pd);</div><div class="line">    if (it == nullptr) return out_of_memory;</div><div class="line"></div><div class="line">    ++(*it);</div><div class="line">    if (*it == it-&gt;end()) &#123;</div><div class="line">        delete it;</div><div class="line">        return unimplemented;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    *iterator = it;</div><div class="line">    return success;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>new primitive_desc_iterator_t的时候返回一个iterator，同时last<em>idx</em>遍历所有op直到末尾，用于end()成员方法的调用。<br>Ps.<br>source insight里面搜索primitive_desc_iterator_t符号<br>using primitive_desc_iterator_t = mkldnn_primitive_desc_iterator;<br>impl<em>list</em>包含了所有kernel的实现</li>
<li>++(*it); primitive_desc_iterator_t里面对++运算符进行了重载，在++重载的运算符中遍历尝试根据输入的类型去创建primitive desc（auto s = impl<em>list</em><a href="&amp;pd_, op_desc_, &amp;attr_, engine_, hint_fwd_pd_">idx_</a>;），创建失败就尝试下一个primitive desc直到成功</li>
<li>if (*it == it-&gt;end()) 判断一下是不是创建成功退出的</li>
<li>*iterator = it; 创建成功的话，直接把it赋值给iterator返回<br>通过以上步骤就找到了对应要调用的primitive_desc<br>后面在创建primitive的时候调用primitive_desc-&gt;create_primitive，就是对应pd的create_primitive函数<br>通过下面对PD的分析可以知道这里调用到的就是pd里面DECLARE_COMMON_PD_T里面的create_primitive方法</li>
</ul>
<h3 id="get-implementation-list在哪里实例化list里面的kernel"><a href="#get-implementation-list在哪里实例化list里面的kernel" class="headerlink" title="get_implementation_list在哪里实例化list里面的kernel"></a>get_implementation_list在哪里实例化list里面的kernel</h3><p>这个engine_是传进来构造的<br>看cpu_engine.cpp文件中get_implementation_list的实现line:331<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">const pd_create_f* cpu_engine_t::get_implementation_list() const &#123;</div><div class="line">    return cpu_impl_list;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里的cpu_impl_list是个列表每个成员都是pd_create_f对象</p>
<p>#define INSTANCE(…) &amp;primitive_desc_t::create<__va_args__::pd_t><br>调用了primitive_desc_t::create<__va_args__::pd_t>创建了每个primitive desc的类型放在cpu_impl_list里面</__va_args__::pd_t></__va_args__::pd_t></p>
<h4 id="using-primitive-desc-t-mkldnn-primitive-desc"><a href="#using-primitive-desc-t-mkldnn-primitive-desc" class="headerlink" title="using primitive_desc_t = mkldnn_primitive_desc;"></a>using primitive_desc_t = mkldnn_primitive_desc;</h4><p>primitive_desc_t就是mkldnn_primitive_desc</p>
<h4 id="mkldnn-primitive-desc"><a href="#mkldnn-primitive-desc" class="headerlink" title="mkldnn_primitive_desc"></a>mkldnn_primitive_desc</h4><p>mkldnn_primitive_desc有create方法，传进来的参数是<strong>VA_ARGS</strong>::pd_t<br>比如_jit_avx512_common_convolution_fwd_t就是这个op的pd_t成员<br>看mkldnn_primitive_desc有create方法，里面调用了_pd-&gt;init()，就是_jit_avx512_common_convolution_fwd_t的pd_t成员的init方法</p>
<h2 id="MKLDNN框架介绍"><a href="#MKLDNN框架介绍" class="headerlink" title="MKLDNN框架介绍"></a>MKLDNN框架介绍</h2><a id="more"></a>
<h3 id="Caffe调用MKLDNN"><a href="#Caffe调用MKLDNN" class="headerlink" title="Caffe调用MKLDNN"></a>Caffe调用MKLDNN</h3><p>可以我的另外一篇博客参考：Caffe中的生产者模式</p>
<ol>
<li>caffe的layer_factory会去创建mkldnn的层</li>
<li>caffe在调用layer.forward函数的时候会调用到对应mkldnn的层的forward_cpu函数</li>
<li>在这个函数中(initxxxpd)的方法会先去判断对应的pd(privimite descriptive)和privimite是否存在，如果不存在的话会去创建对应的pd</li>
<li>在initxxxpd方法中会去调用reset的方法去创建pd(privimite descriptive)和privimite</li>
<li>reset方法的传入的参数就是new出来的一个新的mkldnn的primitive<br><strong>进入mkldnn</strong></li>
<li>在new一个新的mkldnn的primitive的时候，可以看到create后缀或者init后缀的函数</li>
<li>在这些create函数中最后会去调用一个privimite-&gt;create_primitivate的函数，这是个虚函数</li>
<li>这个虚函数和具体的运算kernel之间如何调用实现的，<strong>暂时不是很清楚</strong>，应该有复杂的调用关系，但是核心的思想是：在调用privimite-&gt;create_primitivate的时候会去遍历所有的kernel，在每个kernel的函数中都有一个init_conf的函数，在遍历所有的kernel的时候，会去看这个init_conf的函数是否满足条件，满足条件就意味着调用这个kernel，否则的话就看下个kernel</li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/技术/" rel="tag"># 技术</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/17/区块链/" rel="next" title="区块链">
                <i class="fa fa-chevron-left"></i> 区块链
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/19/MKL/" rel="prev" title="MKL">
                MKL <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2018/01/19/MKLDNN/"
           data-title="MKLDNN" data-url="http://yoursite.com/2018/01/19/MKLDNN/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/popeve.jpg"
               alt="Leslie" />
          <p class="site-author-name" itemprop="name">Leslie</p>
           
              <p class="site-description motion-element" itemprop="description">记录心情与能力的成长</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">71</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#介绍"><span class="nav-number">1.</span> <span class="nav-text">介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#编译安装mkldnn"><span class="nav-number">1.1.</span> <span class="nav-text">编译安装mkldnn</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编译链接代码："><span class="nav-number">1.2.</span> <span class="nav-text">编译链接代码：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Simple-Net-Code-API-代码的解释"><span class="nav-number">1.3.</span> <span class="nav-text">Simple_Net Code API 代码的解释</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调试simple-net-cpp代码"><span class="nav-number">1.4.</span> <span class="nav-text">调试simple_net.cpp代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#看一个primitive的例子："><span class="nav-number">1.4.1.</span> <span class="nav-text">看一个primitive的例子：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#step1："><span class="nav-number">1.4.1.1.</span> <span class="nav-text">step1：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step2："><span class="nav-number">1.4.1.2.</span> <span class="nav-text">step2：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step3："><span class="nav-number">1.4.1.3.</span> <span class="nav-text">step3：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step4"><span class="nav-number">1.4.1.4.</span> <span class="nav-text">step4:</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#看到create-primitive函数创建memory的时候调用了"><span class="nav-number">1.4.1.4.1.</span> <span class="nav-text">看到create_primitive函数创建memory的时候调用了</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#reoder这个op对应了"><span class="nav-number">1.4.1.4.2.</span> <span class="nav-text">reoder这个op对应了</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#conv这个op"><span class="nav-number">1.4.1.4.3.</span> <span class="nav-text">conv这个op</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#jcp变量"><span class="nav-number">1.4.1.4.3.1.</span> <span class="nav-text">jcp变量</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多线程计算的实现"><span class="nav-number">1.5.</span> <span class="nav-text">多线程计算的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#step1"><span class="nav-number">1.5.1.</span> <span class="nav-text">step1:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#step2"><span class="nav-number">1.5.2.</span> <span class="nav-text">step2:</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MKLDNN的primitive如何选择对应的kernel"><span class="nav-number">1.6.</span> <span class="nav-text">MKLDNN的primitive如何选择对应的kernel</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#step1-1"><span class="nav-number">1.6.1.</span> <span class="nav-text">step1:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#step2-1"><span class="nav-number">1.6.2.</span> <span class="nav-text">step2:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#step3"><span class="nav-number">1.6.3.</span> <span class="nav-text">step3:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#step4-1"><span class="nav-number">1.6.4.</span> <span class="nav-text">step4:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#get-implementation-list在哪里实例化list里面的kernel"><span class="nav-number">1.6.5.</span> <span class="nav-text">get_implementation_list在哪里实例化list里面的kernel</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#using-primitive-desc-t-mkldnn-primitive-desc"><span class="nav-number">1.6.5.1.</span> <span class="nav-text">using primitive_desc_t = mkldnn_primitive_desc;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mkldnn-primitive-desc"><span class="nav-number">1.6.5.2.</span> <span class="nav-text">mkldnn_primitive_desc</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MKLDNN框架介绍"><span class="nav-number">1.7.</span> <span class="nav-text">MKLDNN框架介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Caffe调用MKLDNN"><span class="nav-number">1.7.1.</span> <span class="nav-text">Caffe调用MKLDNN</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Leslie</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

<div class="busuanzi-count">

  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">本站访客数<span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv">本站总访问量<span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  

</div>



        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"leslie-fang"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


  

</body>
</html>
